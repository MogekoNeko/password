<!DOCTYPE html>
<html>
<head>
  <title>Nueva Contraseña - Acceso SASA</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="card">
    <h2>Establece tu nueva contraseña</h2>
    <form id="updatePasswordForm">
      <input type="password" id="newPassword" placeholder="Nueva contraseña" required>
      <input type="password" id="confirmPassword" placeholder="Confirmar contraseña" required>
      <button type="submit">Actualizar</button>
    </form>
    <div id="message"></div>
  </div>

  <script>
   // Modifica el script para manejar el token de recuperación:
const supabase = supabase.createClient(
  'https://xfbmdpxyeombmwqhfzug.supabase.co',
  'TU_KEY_PUBLICO_SUPABASE'
)

// Verifica el token en la URL al cargar la página
const urlParams = new URLSearchParams(window.location.search);
const accessToken = urlParams.get('access_token');
const refreshToken = urlParams.get('refresh_token');

if (!accessToken) {
  document.getElementById('message').innerHTML = 
    '<p style="color:red;">Enlace inválido o token expirado</p>';
}

document.getElementById('updatePasswordForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  if(newPassword !== confirmPassword) {
    document.getElementById('message').innerHTML = 
      '<p style="color:red;">Las contraseñas no coinciden</p>';
    return;
  }

  try {
    // Primero establece la sesión con el token
    const { error: authError } = await supabase.auth.setSession({
      access_token: accessToken,
      refresh_token: refreshToken
    });
    
    if (authError) throw authError;
    
    // Luego actualiza la contraseña
    const { error: updateError } = await supabase.auth.updateUser({
      password: newPassword
    });
    
    if (updateError) throw updateError;
    
    document.getElementById('message').innerHTML = 
      '<p style="color:green;">¡Contraseña actualizada con éxito!</p>';
  } catch(error) {
    document.getElementById('message').innerHTML = 
      `<p style="color:red;">Error: ${error.message}</p>`;
  }
});
  </script>
</body>
</html>
